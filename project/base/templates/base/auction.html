{% extends "main.html" %}

{% block content %}

<div class="container p-4">
    <div class="row">
        <div class="col-12 col-md-6 text-center p-4 fs-2">
            <div class="fs-4">توضیحات محصول: <br /> {{ auction.product.description }}</div>
            <hr />
            <div class="fs-4">توضیحات شرکت تولیدکننده: <br /> {{ auction.product.company.description }}</div>
            <hr />
            <div>آخرین پیشنهاد: {% if auction.last_bid %} <a href="{% url 'user-profile' auction.last_bid.user.id %}">{{ auction.last_bid.user.username }}</a> {% else %} هیچکس {% endif %}</div>
            <hr />
            <div>قیمت: {{ auction.current_price }} تومان</div>
            <hr />
            <h4 id="timer" class="w-100 text-center">
                {% if not auction.last_bid %}
                  هنوز شروع نشده!
                {% elif auction.end_time %}
                  فروخته شد!
                {% else %}
                  00:00
                {% endif %}
            </h4>
            <hr />
            <div class="d-flex flex-column align-items-stretch gap-2">
                <form method="post">
                  {% csrf_token %}
                  <button 
                  {% if auction.end_time or auction.last_bid and auction.last_bid.user.id == request.user.id %}
                    disabled
                  {% endif %}
                  class="btn btn-success w-100"
                  type="submit">
                    پیشنهاد
                  </button>
                </form>
                <a href="#" class="btn btn-info">اکنون بخرید</a>
              </div>
        </div>

        <div class="col-12 col-md-6">
            <div class="position-relative">
              <img width="100%" height="100%" src="{% if auction.product.image %} {{ auction.product.image }} {% else %} {{ "https://aqua-air.co.uk/wp-content/uploads/woocommerce-placeholder-600x600.png" }} {% endif %}" alt="">
              
              <img hidden width="90%" height="90%" id="sold-image" class="sold-image" src="https://lizbazi.com/blog/wp-content/uploads/2017/04/sold-out-360x262.png" alt="">
            </div>

            <div class="w-100 text-center fs-1 mt-2">
                محصول <strong>{{ auction.product.name }}</strong> از <strong>{{ auction.product.company.name }}</strong>
            </div>
        </div>
    </div>
    {% comment %} <div>
        <div class="auction-card">
            <h1>{{ auction.product.name }} by {{ auction.product.company.name }}</h1>
            <h2>Buying Price: <span class="price">{{ auction.current_price }}</span></h2>
            <p>Bid Duration: {{ auction.bid_duration }} Seconds</p>
            <p>Last Bidder: {% if auction.last_bid %}{{ auction.last_bid.user.username }}{% else %}None{% endif %}</p>
            <p>Product Description: {{ auction.product.description }}</p>
            <p>Company Description: {{ auction.product.company.description }}</p>
            <p>Product Category: {{ auction.product.category }}</p>
            <form method="post" action="{% url 'create-bid-home' auction.id %}">
              {% csrf_token %}
              <button type="submit">Bid Now!</button>
            </form>

            <!-- Add more details or customizations here -->
        </div>
    </div> {% endcomment %}

</div>

<hr />

<div class="container pb-4">
  <div class="fs-3">پیشنهاد‌های پیشین:</div>
  <div dir="ltr">
    {% for bid in auction.bids.all %}
    <div>{{ bid.user.name }} @ {{ bid.created_at }}</div>
    {% endfor %}
  </div>
</div>

{% if auction.end_time %}
  <script>
    document.getElementById("sold-image").hidden = false;
  </script>
{% endif %}

{% if auction.last_bid and not auction.end_time %}
  <script>
    finishTime = new Date("{{ auction.last_bid.created_at|date:'Y-m-d\TH:i:s\Z' }}");
    finishTime.setSeconds(finishTime.getSeconds() + {{ auction.bid_duration }});
    interval = setInterval(() => {
      var remainingTime = Math.floor((finishTime - Date.now()) / 1000);
      if (remainingTime < 0) {
        clearInterval(interval);
        document.getElementById("sold-image").hidden = false;
        document.getElementById("timer").innerText = "فروخته شد!"
        return;
      }
      var remainingTimeString = `${String(Math.floor(remainingTime / 60)).padStart(2, '0')}:${String(remainingTime % 60).padStart(2, '0')}`;
      document.getElementById("timer").innerText = remainingTimeString;
    }, 1000);
  </script>
{% endif %}

{% endblock content %}
